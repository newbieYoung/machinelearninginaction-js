<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>简单线性回归梯度下降示例</title>
</head>
<body>
<div id="container" style="width: 600px;height:400px;"></div>
<script src="../lib/highcharts.js"></script>
<script>
    window.onload = function () {
        // 图表
        var chart;
        var options = {
            title: {
                text: 'ex0.txt'
            },
            xAxis: {},
            yAxis: {},
            series: [{
                type:'scatter',
                name: '数据',
                data: []
            },{
                type:'line',
                name: '线性回归线'
            }]
        };

        //fetch通过url获取文件
        fetch('./ex0.txt')
        .then(function(res){
            return res.blob();
        })
        .then(function(blob){
            handleData(blob);
        });

        //处理数据
        function handleData(blob){
            var reader = new FileReader();
            reader.onload = function () {
                //整理数据
                var data = [];//散点图表数据
                var process = [];//拟合过渡数据

                var str = reader.result;
                var arr = str.split(/[\s\n]/g);
                for(var i=0;i<arr.length;i++){
                    arr[i] = parseFloat(arr[i]);//转换为浮点数
                }
                console.log(arr.length);
                var result = [];//散点模型数据
                for(var i=0;i<arr.length;i = i+3){
                    data.push([arr[i+1],arr[i+2]]);
                    if(arr[i]&&arr[i+1]&&arr[i+2]){//去掉不合法的数据
                        result.push([arr[i],arr[i+1],arr[i+2]]);
                    }
                }

                //绘制散点图
                renderPoint(data);
                process.push(InitParams);

                //梯度下降
                lastCost = cost(InitParams,result,func);
                var no = 0;
                do{
                    if(currentCost){
                        lastCost = currentCost;
                    }
                    InitParams = iterator(InitParams,result,func);
                    currentCost = cost(InitParams,result,func);

                    //console.log('----');
                    //console.log(InitParams);
                    //console.log(currentCost);
                    //console.log(lastCost);
                    //console.log(Math.abs(currentCost-lastCost));
                    process.push(InitParams);
                }while(Math.abs(currentCost-lastCost)>0.001)

                console.log(process.length);

                //梯度下降过程可视化
                for(var i=0;i<process.length;i++){
                    (function(index){
                        setTimeout(function(){
                            renderLine(process[index]);
                            console.log('-- '+index+' --');
                            console.log(process[index]);
                            if(index==process.length-1){
                                console.log('-- end --');
                            }
                        },200*index)
                    })(i);
                }
            };
            reader.readAsText(blob);
        }

        //渲染散点图数据
        function renderPoint(data){
            if(!chart){//图表不存在则先初始化
                chart = Highcharts.chart('container', options);
            }
            chart.series[0].setData(data);
        }

        //渲染线性回归方程
        function renderLine(params){
            if(!chart){//图表不存在则先初始化
                chart = Highcharts.chart('container', options);
            }
            chart.series[1].setData([[0,func(params.w1,params.w2,0)],[1,func(params.w1,params.w2,1)]]);
        }

        //线性模型
        function func(w1,w2,x){
            return w1+w2*x;
        }
        //初始化参数
        var InitParams = {
            w1:5,
            w2:5,
            v:1//学习速度
        };
        var lastCost;
        var currentCost;

                //梯度下降
        function iterator(params,arr,f){
            var next = {
                w1:params.w1,
                w2:params.w2,
                v:params.v
            };
            next.w1 = params.w1 - params.v*sum(0,params,arr,f);
            next.w2 = params.w2 - params.v*sum(1,params,arr,f);
            return next;
        }

        function sum(index,params,arr,f){
            var total = 0;
            for(var i=0;i<arr.length;i++){
                var item = arr[i];
                total += (f(params.w1,params.w2,item[1])-item[2])*item[index];
            }
            total = total/arr.length;
            return total;
        }

        //损失函数
        function cost(params,arr,f){
            var total = 0;
            for(var i=0;i<arr.length;i++){
                var item = arr[i];
                total += Math.pow(f(params.w1,params.w2,item[1])-item[2],2);
            }
            return total;
        }
    }

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>K近邻算法手写数字识别</title>
    <style>
        body{
            margin:0;
            padding:0;
            background-color:gray;
        }
    </style>
</head>
<body>
    <canvas id="signature" width="320" height="320"></canvas>
    <div>
        <button id="clear">清空</button>
        <button id="recoganise">识别</button>
    </div>
    <pre id="output"></pre>
    <script src="../node_modules/signature_pad/dist/signature_pad.js"></script>
    <script>
        window.onload = function(){

            //数据是否准备完成
            function arrayIsFinished(array){
                var result = true;
                for(var i=0;i<array.length;i++){
                    if(array[i]==null||array[i].length<=0){
                        result = false;
                        break;
                    }
                }
                return result;
            }

            //整理数据
            var no = 0;//数字
            var num = 0;//个数
            var loadTag = false;
            var data = [];//二进制数据
            var array = [];//数组数据
            var results = [];

            function load(){
                var path = './digits/'+no+'_'+num+'.txt';
                //console.log(path);
                fetch(path)//fetch通过url获取文件
                .then(function(res) {
                    loadTag = res.ok;//加载结果标识
                    return res.blob();
                })
                .then(function(blob){
                    if(loadTag){
                        data.push(blob);
                        results.push(no);
                        num++;
                        load();
                    }else{
                        no++;//数字递增
                        num = 0;
                        if(no<=9){//10以下继续加载
                            load();
                        }else{
                            //console.log(data);
                            console.log('load end');

                            //解析二进制
                            for(var i=0;i<data.length;i++){
                                (function(index){
                                    array[index] = [];
                                    var reader = new FileReader();
                                    reader.onload = function(){
                                        for(var j=0;j<reader.result.length;j++){
                                            var char = reader.result[j];
                                            var number = parseInt(char);
                                            if(number>=0&&number<=9){
                                                array[index].push(number);
                                            }
                                        }

                                        //全部解析完成
                                        //if(arrayIsFinished(array)){
                                        //    console.log(array);
                                        //    console.log(result);
                                        //}
                                    }
                                    reader.readAsText(data[index]);
                                })(i)
                            }
                        }
                    }
                });
            }
            load();

            //数据输入
            var $output = document.querySelector('#output');
            var input = [];
            var $signature = document.querySelector('#signature');
            var signaturePad = new SignaturePad($signature, {
                minWidth: 10,
                maxWidth: 20,
                penColor: "rgb(0, 0, 0)",
                backgroundColor: 'rgb(255, 255, 255)'
            });
            var $clearBtn = document.querySelector('#clear');//清空
            $clearBtn.addEventListener('click',function(){
                signaturePad.clear();
                input = [];
            })
            var $recoganise = document.querySelector('#recoganise');//识别
            $recoganise.addEventListener('click',function(){
                var size = {
                    width:32,
                    height:32
                }
                var $small = document.createElement('canvas');
                $small.width = size.width;
                $small.height = size.height;
                var context = $small.getContext('2d');
                context.drawImage($signature,0,0,size.width,size.height);
                var imageData = context.getImageData(0,0,size.width,size.height);
                for(var i=0;i<imageData.data.length;i=i+4){
                    var r = imageData.data[i];
                    var g = imageData.data[i+1];
                    var b = imageData.data[i+2];
                    var a = imageData.data[i+3];
                    if(r==g&&g==b&&b==a&&a==255){
                        input.push(0);
                    }else{
                        input.push(1);
                    }
                }

                //可视化检测
                var html = '';
                for(var i=0;i<32;i++){
                    var line = '';
                    for(var j=0;j<32;j++){
                        line += input[i*32+j];
                    }
                    html += line+'\n';
                }
                $output.innerHTML = html;

                var number = knn(input,array,results,3);

                /**
                 * 样本太少，识别率较低
                 */
                console.log('您输入的数字是：'+number);
                alert('您输入的数字是：'+number);
            })

            //k近邻算法
            function knn(input,data,results,k){
                var lens = [];
                for(var i=0;i<data.length;i++){
                    var item = data[i];
                    var len = 0;
                    for(var j=0;j<item.length;j++){
                        len += Math.pow(item[j]-input[j],2);
                    }
                    lens.push({
                        index:i,
                        len:len
                    });

                }
                lens.sort(function(a,b){//按距离从小到大排序
                    if(a.len>b.len){
                        return 1;
                    }
                    if(a.len<b.len){
                        return -1;
                    }
                    return 0;
                });

                var counts = [0,0,0,0,0,0,0,0,0,0];//从0到9计算统计

                var list = lens.slice(0,k);
                for(var i=0;i<list.length;i++){
                    counts[results[list[i].index]]++;
                }
                console.log(counts);

                //选择最大的那个
                var max = 0;
                var no = 0;
                for(var i=0;i<counts.length;i++){
                    if(counts[i]>max){
                        max = counts[i];
                        no = i;
                    }
                }

                return no;
            }
        }
    </script>
</body>
</html>